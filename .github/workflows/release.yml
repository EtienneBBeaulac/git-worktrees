name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION_NUMBER=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Auto-update version in code
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          echo "📝 Updating version to $VERSION_NUMBER in code..."
          
          # Update wt-common.zsh
          sed -i 's/^typeset -g WT_VERSION=.*/typeset -g WT_VERSION="'"$VERSION_NUMBER"'"/' scripts/lib/wt-common.zsh
          
          # Check if anything changed
          if ! git diff --quiet scripts/lib/wt-common.zsh; then
            echo "✅ Version updated in scripts/lib/wt-common.zsh"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add scripts/lib/wt-common.zsh
            git commit -m "chore: bump version to $VERSION_NUMBER [skip ci]"
            git push origin HEAD:main
            echo "✅ Pushed version update to main"
          else
            echo "ℹ️  Version already up to date"
          fi
      
      - name: Wait for GitHub to generate tarball
        run: sleep 10
      
      - name: Calculate SHA256
        id: sha256
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.version.outputs.VERSION }}.tar.gz"
          SHA256=$(curl -fsSL "$TARBALL_URL" | sha256sum | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "TARBALL_URL=$TARBALL_URL" >> $GITHUB_OUTPUT
      
      - name: Update Formula in main repo
        run: |
          sed -i "s|url \".*\"|url \"${{ steps.sha256.outputs.TARBALL_URL }}\"|" Formula/git-worktrees.rb
          sed -i "s|sha256 \".*\"|sha256 \"${{ steps.sha256.outputs.SHA256 }}\"|" Formula/git-worktrees.rb
      
      - name: Commit Formula update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/git-worktrees.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update Homebrew formula to ${{ steps.version.outputs.VERSION }}"
            git push origin HEAD:main
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: ${{ contains(github.ref, '-test') || contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          body: |
            ## Installation
            
            ### Homebrew
            ```bash
            brew update
            brew upgrade git-worktrees
            ```
            
            ### Install Script
            ```bash
            curl -fsSL https://raw.githubusercontent.com/EtienneBBeaulac/git-worktrees/main/install.sh | bash
            ```
            
            ## What's Changed
            See the release notes below for details.

  update-tap:
    needs: release
    runs-on: ubuntu-latest
    # Skip tap update for test releases
    if: "!contains(github.ref, '-test') && !contains(github.ref, '-alpha') && !contains(github.ref, '-beta') && !contains(github.ref, '-rc')"
    
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: EtienneBBeaulac/homebrew-tap
          token: ${{ secrets.TAP_UPDATE_TOKEN }}
          path: homebrew-tap
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Calculate SHA256
        id: sha256
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.version.outputs.VERSION }}.tar.gz"
          SHA256=$(curl -fsSL "$TARBALL_URL" | sha256sum | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "TARBALL_URL=$TARBALL_URL" >> $GITHUB_OUTPUT
      
      - name: Update Formula in tap
        working-directory: homebrew-tap
        run: |
          sed -i "s|url \".*\"|url \"${{ steps.sha256.outputs.TARBALL_URL }}\"|" Formula/git-worktrees.rb
          sed -i "s|sha256 \".*\"|sha256 \"${{ steps.sha256.outputs.SHA256 }}\"|" Formula/git-worktrees.rb
      
      - name: Commit and push to tap
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/git-worktrees.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update git-worktrees to ${{ steps.version.outputs.VERSION }}"
            git push
          fi

